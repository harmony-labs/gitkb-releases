name: Test Install Script

on:
  # Auto-trigger after every new release
  workflow_run:
    workflows: ["Mirror Release"]
    types: [completed]

  # Test PRs that touch the installer
  pull_request:
    paths: [install.sh]

  # Manual trigger with optional version override
  workflow_dispatch:
    inputs:
      version:
        description: "Version to install (e.g. 0.3.1). Blank = latest."
        required: false
        default: ""

jobs:
  # ---------------------------------------------------------------------------
  # Linux — Docker containers give a clean, minimal environment
  # ---------------------------------------------------------------------------
  test-linux:
    if: >-
      github.event_name != 'workflow_run' ||
      github.event.workflow_run.conclusion == 'success'
    strategy:
      fail-fast: false
      matrix:
        include:
          # x64: oldest supported (glibc 2.35), stable (glibc 2.36), and newest
          - distro: ubuntu:22.04
            runner: ubuntu-latest
            name: ubuntu-22.04-x64
          - distro: debian:bookworm-slim
            runner: ubuntu-latest
            name: debian-bookworm-x64
          - distro: ubuntu:24.04
            runner: ubuntu-latest
            name: ubuntu-24.04-x64
          # arm64: binary requires glibc 2.39 (built on ubuntu-24.04-arm)
          - distro: ubuntu:24.04
            runner: ubuntu-24.04-arm
            name: ubuntu-24.04-arm64
    runs-on: ${{ matrix.runner }}
    name: linux / ${{ matrix.name }}
    steps:
      - uses: actions/checkout@v4

      - name: Pull Docker image (cached by runner)
        run: docker pull ${{ matrix.distro }}

      - name: Run install.sh in Docker
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          INPUT_VERSION: ${{ github.event.inputs.version }}
        run: |
          docker run --rm \
            -e GITHUB_TOKEN \
            -e VERSION="${INPUT_VERSION:-latest}" \
            -v "${{ github.workspace }}/install.sh:/install.sh:ro" \
            ${{ matrix.distro }} \
            bash -c '
              set -euo pipefail

              # --- Dependencies ------------------------------------------------
              apt-get update -qq && apt-get install -y -qq curl ca-certificates libdbus-1-3 >/dev/null

              # --- Private-repo auth (no-op once public) ----------------------
              if [ -n "${GITHUB_TOKEN:-}" ]; then
                echo "machine github.com login x-access-token password ${GITHUB_TOKEN}" > ~/.netrc
                chmod 600 ~/.netrc
              fi

              # --- Run installer -----------------------------------------------
              bash /install.sh 2>/tmp/install_stderr.log

              # --- Assertions ---------------------------------------------------
              test -f "$HOME/.local/bin/git-kb" || { echo "FAIL: binary not found"; exit 1; }
              "$HOME/.local/bin/git-kb" --version     # proves correct arch + no missing libs

              # No unbound variable errors or other stderr noise
              if [ -s /tmp/install_stderr.log ]; then
                echo "FAIL: install.sh produced unexpected stderr output:"
                cat /tmp/install_stderr.log
                exit 1
              fi
            '

  # ---------------------------------------------------------------------------
  # macOS — native runners (can't use Docker on macOS)
  # ---------------------------------------------------------------------------
  test-macos:
    if: >-
      github.event_name != 'workflow_run' ||
      github.event.workflow_run.conclusion == 'success'
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: macos-latest
            name: macos-arm64
          - runner: macos-15-intel
            name: macos-x64
    runs-on: ${{ matrix.runner }}
    name: macos / ${{ matrix.name }}
    steps:
      - uses: actions/checkout@v4

      - name: Private-repo auth (no-op once public)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -n "${GITHUB_TOKEN:-}" ]; then
            echo "machine github.com login x-access-token password ${GITHUB_TOKEN}" > ~/.netrc
            chmod 600 ~/.netrc
          fi

      - name: Run install.sh
        env:
          VERSION: ${{ github.event.inputs.version || 'latest' }}
        run: bash install.sh 2>/tmp/install_stderr.log

      - name: Verify installation
        run: |
          test -f "$HOME/.local/bin/git-kb" || { echo "FAIL: binary not found"; exit 1; }
          "$HOME/.local/bin/git-kb" --version

          # No unbound variable errors or other stderr noise
          if [ -s /tmp/install_stderr.log ]; then
            echo "FAIL: install.sh produced unexpected stderr output:"
            cat /tmp/install_stderr.log
            exit 1
          fi

  # ---------------------------------------------------------------------------
  # Summary — single required check for branch protection
  # ---------------------------------------------------------------------------
  results:
    if: always()
    needs: [test-linux, test-macos]
    runs-on: ubuntu-latest
    name: results
    steps:
      - name: Aggregate results
        run: |
          echo "linux:  ${{ needs.test-linux.result }}"
          echo "macos:  ${{ needs.test-macos.result }}"
          if [[ "${{ needs.test-linux.result }}" == "skipped" && \
                "${{ needs.test-macos.result }}" == "skipped" ]]; then
            echo "Tests skipped (upstream workflow did not succeed)."
            exit 0
          fi
          # Treat skipped as acceptable when paired with success
          linux_ok=$([[ "${{ needs.test-linux.result }}" =~ ^(success|skipped)$ ]] && echo true || echo false)
          macos_ok=$([[ "${{ needs.test-macos.result }}" =~ ^(success|skipped)$ ]] && echo true || echo false)
          if [[ "$linux_ok" == "true" && "$macos_ok" == "true" ]]; then
            echo "All install tests passed."
          else
            echo "One or more install tests failed."
            exit 1
          fi
